/*
SOURCE:
-https://www.youtube.com/watch?v=ZKtvHS2Mc1Y&list=PLVlQHNRLflP8WFEvFvANnUsD2y8HJIJh1&index=32
-https://www.youtube.com/watch?v=uNdZyBQdqAs&list=PLVlQHNRLflP8WFEvFvANnUsD2y8HJIJh1&index=33
*/

USE MOVIES
GO

-- DATA PREPARATION

--PARENT TABLE
CREATE TABLE MYDEMO.CASCADEDEMO(ID INT PRIMARY KEY, NAME VARCHAR(50))

INSERT INTO MYDEMO.CASCADEDEMO(ID, NAME)
VALUES (1, 'ASDF'),(2,'DFGH'),(3,'HJKL')

SELECT * FROM MYDEMO.CASCADEDEMO

--CHILD TABLE
CREATE TABLE MYDEMO.CASCADEDEMO_CHILD(MOBILE VARCHAR(10) PRIMARY KEY, ID INT FOREIGN KEY REFERENCES MYDEMO.CASCADEDEMO(ID))

INSERT INTO MYDEMO.CASCADEDEMO_CHILD(MOBILE,ID)
VALUES (987123, 1),(987345,1),(987567,2),(987876,3),(887766,3),(654321,2),(566655,1)

SELECT * FROM MYDEMO.CASCADEDEMO_CHILD

-- WITHOUT CASCADE ( INSERT - PARENT ONLY // UPDATE - CHILD ONLY // DELETE - CHILD ONLY)

-- INSERT

INSERT INTO MYDEMO.CASCADEDEMO_CHILD(MOBILE,ID)
VALUES (99999, 4)
-- ERROR BECASUSE IN CHILD TABLE, ID=4 (FK) DOESN'T EXIST IN PARENT TABLE (ID -->PK)
-- NO INSERTIN ERROR FACED ON PARENT TABLE


-- UPDATE

UPDATE MYDEMO.CASCADEDEMO SET ID = 5 WHERE ID = 1
-- PK VALUE UPDATION IN PARENT TABLE IS NOT ALLOWED


-- DELETE

DELETE FROM MYDEMO.CASCADEDEMO WHERE ID = 1
-- PARENT TABLE ROW CANNOT BE DELETED AS PK IN PARENT IS LINKED TO FK IN CHILD.

-- SUMMARY:
-- INSERTION IN CHILD TABLE FAILED DUE TO UN-REFERENCED VALUE - IS GOOD RULE AND AVOIDS CONFUSION IN THE DBMS - ACCEPPTED. THIS CANNOT BE CHANGED.
-- UPDATION & DELETION OF THE PARENT TABLE IS REQUIRED IN REAL TIME. HOW DO WE MANAGE THIS?

-- WITH CASCADE

--NOTE : WHEN WE WANT TO PERFORM UPDATE OR DELETE OPERATIONS ON PARENT TABLE REFERENCE COLUMN,
-- ALONGWITH CHILD TABLE REFERENCE COLUMN DATA.

-- TYPES:

-- A.) ON UPDATE CASCADE - WHEN WE WANT TO PERFORM UPDATE OPERATION ON PARENT TABLE REFERENCE COLUMN,
-- ALONGWITH CHILD TABLE REFERENCE COLUMN DATA.


-- B.) ON DELETE CASCADE - WHEN WE WANT TO PERFORM DELETE OPERATION ON PARENT TABLE REFERENCE COLUMN,
-- ALONGWITH CHILD TABLE REFERENCE COLUMN DATA.

-- NOTE : "CASCADE RULES ARE IMPOSED ON CHILD TABLES - FOREIGN KEY COLUMNS ONLY."

-- DATA PREPARATION

--PARENT TABLE
CREATE TABLE MYDEMO.CASCADEDEMO_NEW(ID INT PRIMARY KEY, NAME VARCHAR(50))

INSERT INTO MYDEMO.CASCADEDEMO_NEW(ID, NAME)
VALUES (1, 'ASDF'),(2,'DFGH'),(3,'HJKL')

SELECT * FROM MYDEMO.CASCADEDEMO_NEW

--CHILD TABLE
CREATE TABLE MYDEMO.CASCADEDEMO_CHILD_NEW
(MOBILE VARCHAR(10) PRIMARY KEY, ID INT FOREIGN KEY REFERENCES 
MYDEMO.CASCADEDEMO_NEW(ID) ON UPDATE CASCADE ON DELETE CASCADE)

INSERT INTO MYDEMO.CASCADEDEMO_CHILD_NEW(MOBILE,ID)
VALUES (987123, 1),(987345,1),(987567,2),(987876,3),(887766,3),(654321,2),(566655,1)

SELECT * FROM MYDEMO.CASCADEDEMO_CHILD_NEW

-- REAL DEMO :)

-- UPDATE

UPDATE MYDEMO.CASCADEDEMO_NEW SET ID = 5 WHERE ID = 1

--SEE THE IMPACT
SELECT * FROM MYDEMO.CASCADEDEMO_NEW
SELECT * FROM MYDEMO.CASCADEDEMO_CHILD_NEW

-- DELETE

DELETE FROM MYDEMO.CASCADEDEMO_NEW WHERE ID = 2

--SEE THE IMPACT
SELECT * FROM MYDEMO.CASCADEDEMO_NEW
SELECT * FROM MYDEMO.CASCADEDEMO_CHILD_NEW

-- WHAT IF TABLE IS ALREADY CREATED?
https://stackoverflow.com/questions/6260688/how-do-i-use-cascade-delete-with-sql-server#:~:text=To%20add%20%22Cascade%20delete%22%20to,in%20a%20new%20Query%20window.&text=And%20hit%20the%20%22Execute%22%20button%20to%20run%20this%20query.&text=The%20SQL%20in%20that%20article,which%20reference%20a%20particular%20table.